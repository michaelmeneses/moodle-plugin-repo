name: Fix Checksums

on:
  workflow_dispatch:

jobs:
  fix-checksums:
    name: Fix Checksums
    runs-on: ubuntu-latest

    container:
      image: middagtec/image-bitbucket-ci:v5-php82
      options: --user root

    env:
      COMPOSER_ALLOW_SUPERUSER: 1
      PROCESS_TIMEOUT: 21600
      COMPOSER_PROCESS_TIMEOUT: 21600
      COMPOSER_MEMORY_LIMIT: -1

      # Envs for Satis MIDDAG
      SATIS_NAME: ${{ vars.SATIS_NAME }}
      SATIS_URL: ${{ vars.SATIS_URL }}

      # Envs for S3 Satis (Cloudflare R2)
      S3_BUCKET: ${{ vars.S3_BUCKET }}
      S3_ACCESS_KEY_ID: ${{ vars.S3_ACCESS_KEY_ID }}
      S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
      S3_REGION: ${{ vars.S3_REGION }}
      S3_ENDPOINT: ${{ vars.S3_ENDPOINT }}
      S3_USE_PATH_STYLE_ENDPOINT: ${{ vars.S3_USE_PATH_STYLE_ENDPOINT }}
      S3_SATIS_CACHE_DIR: ${{ vars.S3_SATIS_CACHE_DIR }}
      S3_SATIS_CACHE_CHECKSUMS: ${{ vars.S3_SATIS_CACHE_CHECKSUMS }}
      S3C_USE_RCLONE: ${{ vars.S3C_USE_RCLONE }}

    steps:
      - name: Checkout source-code
        uses: actions/checkout@v4

      - name: Restore temp checksums cache
        id: restore-temp-checksums
        uses: actions/cache/restore@v4
        with:
          path: ${{ vars.S3_SATIS_CACHE_CHECKSUMS }}
          key: checksums-temp-${{ runner.os }}
          restore-keys: |
            checksums-temp-${{ runner.os }}

      - name: Generate missing checksums with script
        run: |
          set -e
          export TMP_WORK=$S3_SATIS_CACHE_CHECKSUMS
          echo ">> Running s3-checksums.sh to verify and fix any missing checksums"
          chmod +x scripts/s3-checksums.sh
          composer run checksums:s3

      - name: Save temp checksums cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ vars.S3_SATIS_CACHE_CHECKSUMS }}
          key: checksums-temp-${{ runner.os }}

      - name: Show cache state summary
        run: |
          echo "Cache states:"
          du -sh $S3_SATIS_CACHE_CHECKSUMS || true
